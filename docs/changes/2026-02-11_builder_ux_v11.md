# 1. CONTEXTO
Se necesitaba endurecer el flujo de `/coach/workouts` para que opere como builder **solo de tests** (`is_test=true`), con UX guiada (stepper), control de `scoreType`, edición de ideal scores (community/gym), duplicación a borrador y validaciones orientadas a evitar configuraciones inválidas antes de guardar/publicar.

# 2. CAMBIOS REALIZADOS
## Archivos modificados
- `backend/src/adapters/inbound/http/errors.py`
- `backend/src/adapters/inbound/http/routers/coach.py`
- `backend/src/application/dtos/__init__.py`
- `backend/src/application/dtos/coach.py`
- `backend/src/application/services/runtime_service.py`
- `backend/tests/test_api_flows.py`
- `packages/types/src/dtos.ts`
- `packages/sdk/src/api.ts`
- `apps/web/app/coach/workouts/page.tsx`
- `apps/web/app/coach/workouts/_components/workout-builder.tsx`

## Funciones/clases añadidas
- `BadRequestError` en `backend/src/application/services/runtime_service.py`.
- Endpoints coach en `backend/src/adapters/inbound/http/routers/coach.py`:
  - `GET /api/v1/coach/workouts/{workout_id}/ideal-scores`
  - `PUT /api/v1/coach/workouts/{workout_id}/ideal-scores/community`
  - `PUT /api/v1/coach/workouts/{workout_id}/ideal-scores/gym/{gym_id}`
- DTOs nuevos en `backend/src/application/dtos/coach.py`:
  - `DuplicateWorkoutResponseDTO`
  - `IdealScoreUpsertRequestDTO`
  - `IdealScoreScopeEntryDTO`
  - `IdealScoreGymEntryDTO`
  - `IdealScoreGetResponseDTO`
- Métodos de servicio nuevos en `backend/src/application/services/runtime_service.py`:
  - `get_workout_ideal_scores`
  - `upsert_workout_community_ideal_score`
  - `upsert_workout_gym_ideal_score`
  - `_upsert_ideal_profile`
  - `_default_score_type`

## Funciones modificadas
- `RuntimeService.coach_workouts`: ahora filtra solo tests.
- `RuntimeService.create_workout` y `RuntimeService.update_workout`:
  - rechazan `is_test=false` con 400.
  - aplican default de `score_type` según `WorkoutType` si no viene.
- `RuntimeService.duplicate_workout`:
  - respuesta reducida a `{id}`.
  - duplica como draft (`published_at=null`), sin assignments.
- `RuntimeService._validate_workout_payload`: ahora valida con `score_type` efectivo.
- `to_http_exception` (`backend/src/adapters/inbound/http/errors.py`): mapea `BadRequestError` a HTTP 400.

## Contratos/DTOs TS modificados
- `packages/types/src/dtos.ts`:
  - `DuplicateWorkoutResponseDTO`
  - `IdealScoreGetResponse`
  - `IdealScoreUpsertRequest`
  - tipos auxiliares de ideal score.
- `packages/sdk/src/api.ts`:
  - `duplicateWorkout()` devuelve `DuplicateWorkoutResponseDTO`.
  - nuevos métodos:
    - `getIdealScores(workoutId)`
    - `setCommunityIdealScore(workoutId, payload)`
    - `setGymIdealScore(workoutId, gymId, payload)`

## Cambios UI
- `apps/web/app/coach/workouts/page.tsx`:
  - vista enfocada a tests (`isTest=true`).
  - acción duplicar abre `/coach/workouts/{newId}/edit` con aviso “Duplicado como borrador”.
- `apps/web/app/coach/workouts/_components/workout-builder.tsx`:
  - stepper 3 pasos (Identidad/Estructura/Impacto).
  - scoreType default por type con override manual.
  - editor de scales simple (`rx_male`, `rx_female`, `scaled_male`, `scaled_female`) y modo avanzado JSON.
  - botón generador EMOM 10’ (20 bloques alternos).
  - presets de capacity weights + texto de impacto principal.
  - editor de ideal scores (community/gym) con reglas por rol.
  - panel de validación con errores accionables y navegación por paso.
  - modal de publicación con scope `GYM|COMMUNITY`.

# 3. IMPACTO EN EL DOMINIO
- **Atletas**: sin cambios directos de contrato de atleta; reciben indirectamente mejor calidad de tests publicados.
- **Capacidades**: mejora de gobernanza al obligar capacity weights consistentes y permitir ideal scores editables por coach/admin.
- **Workouts/Tests**: `/coach/workouts` se consolida como flujo test-first; se reduce riesgo de crear workouts no-test desde esa ruta.
- **Ranking**: ideal scores (community/gym) impactan normalización de score vía lógica existente.
- **Persistencia**: no se altera schema en esta intervención; se explotan datos existentes (`workout_ideal_profiles`) vía endpoints.

# 4. ESTADO DE USO
- ? EN USO:
  - `RuntimeService.get_workout_ideal_scores` (router coach ideal-scores GET)
  - `RuntimeService.upsert_workout_community_ideal_score` (router coach ideal-scores community PUT)
  - `RuntimeService.upsert_workout_gym_ideal_score` (router coach ideal-scores gym PUT)
  - `RuntimeService._default_score_type` (create/update/duplicate workflows)
  - `DuplicateWorkoutResponseDTO` (backend coach router + SDK + web list)
  - `IdealScoreGetResponseDTO` y `IdealScoreUpsertRequestDTO` (backend + SDK + builder web)
  - `webApi.getIdealScores`, `webApi.setCommunityIdealScore`, `webApi.setGymIdealScore` (builder web)
- ?? EN TRANSICIÓN:
  - N/A
- ? DEPRECADA (pero mantenida):
  - N/A
- ?? ELIMINADA:
  - N/A

# 5. RIESGO DE REFRACTOR FUTURO
- `RuntimeService` sigue siendo implementación in-memory y está acoplada a semántica de prototipo; al migrar a repos persistentes habrá que portar reglas de permisos/validación y upserts de ideal scores.
- El builder web concentra bastante lógica de estado; conviene separar en hooks/servicios UI cuando crezca (riesgo de mantenimiento).
- El path trackeado `packages/sdk/node_modules/@packages/types/src/dtos.ts` sigue acoplado al workspace actual; en refactor de monorepo conviene desacoplar artefactos trackeados en `node_modules`.

# 6. CONTRATO EXTERNO AFECTADO
- **API**: sí.
  - Nuevo contrato de `duplicate` en coach: devuelve `{ id }`.
  - Nuevos endpoints de ideal score (GET/PUT community/PUT gym).
  - Validación nueva: `is_test=false` en coach workouts => HTTP 400.
  - `scoreType` se autocompleta por backend si no viene.
- **Respuesta frontend**: sí, adaptada en SDK y páginas web coach.
- **Base de datos**: no cambios de schema en este parche.
- **Seeds**: sin cambios en esta intervención.

# 7. CHECK DE COHERENCIA
- Arquitectura hexagonal: ? se mantiene (routers/adapters delegan a application service; dominio no depende de FastAPI/SQLAlchemy).
- Separación dominio/aplicación/infrastructure: ? sin ruptura.
- Invariantes de negocio: ? reforzados (tests-only en coach workouts, scoreType consistente, validaciones de estructura y pesos, permisos de ideal score por rol/gym).
